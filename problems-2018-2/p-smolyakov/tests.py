import bytes_hist
import unittest
import subprocess


class TranslatorTests(unittest.TestCase):
    def __test_subprocess(self, filename, expected_output):
        try:
            result = subprocess.run(f'cat {filename} | python3 bytes_hist.py', capture_output=True, text=True, shell=True)
        except Exception as e:
            self.fail(f"Met exception while running subprocess: {repr(e)}")

        self.assertEqual(result.returncode, 0)
        self.assertIn(expected_output, result.stdout)


    def test_koi8(self):
        expected_output = """Statistics:
0xc5 ::  8.70% (4)
0xc1 ::  6.52% (3)
0xc8 ::  6.52% (3)
0xc9 ::  6.52% (3)
0xcb ::  6.52% (3)
0xd3 ::  4.35% (2)
0xd5 ::  4.35% (2)
0xa3 ::  2.17% (1)
0xc0 ::  2.17% (1)
0xc2 ::  2.17% (1)
0xc3 ::  2.17% (1)
0xc4 ::  2.17% (1)
0xc6 ::  2.17% (1)
0xc7 ::  2.17% (1)
0xca ::  2.17% (1)
0xcc ::  2.17% (1)
0xcd ::  2.17% (1)
0xce ::  2.17% (1)
0xcf ::  2.17% (1)
0xd0 ::  2.17% (1)
0xd1 ::  2.17% (1)
0xd2 ::  2.17% (1)
0xd4 ::  2.17% (1)
0xd6 ::  2.17% (1)
0xd7 ::  2.17% (1)
0xd8 ::  2.17% (1)
0xd9 ::  2.17% (1)
0xda ::  2.17% (1)
0xdb ::  2.17% (1)
0xdc ::  2.17% (1)
0xdd ::  2.17% (1)
0xde ::  2.17% (1)
0xdf ::  2.17% (1)
ALL  :: 100.0% (46)
"""
        self.__test_subprocess('test_french_bulki_koi8-r.txt', expected_output)


    def test_cp1251(self):
        expected_output="""Statistics:
0xee :: 11.21% (60386)
0xe0 ::  8.19% (44106)
0xe5 ::  7.85% (42290)
0xe8 ::  6.56% (35357)
0xed ::  6.31% (33970)
0xf2 ::  5.60% (30139)
0xf1 ::  5.13% (27626)
0xeb ::  5.03% (27120)
0xf0 ::  4.47% (24085)
0xe2 ::  4.40% (23685)
0xea ::  3.41% (18364)
0xe4 ::  2.94% (15826)
0xf3 ::  2.85% (15334)
0xec ::  2.84% (15319)
0xef ::  2.38% (12804)
0xff ::  2.26% (12166)
0xe3 ::  2.02% (10905)
0xfc ::  1.95% (10487)
0xfb ::  1.90% (10223)
0xe7 ::  1.76% (9481)
0xe1 ::  1.57% (8481)
0xf7 ::  1.32% (7126)
0xe9 ::  1.15% (6203)
0xe6 ::  1.00% (5375)
0xf8 ::  0.93% (5018)
0xf5 ::  0.84% (4534)
0xfe ::  0.65% (3486)
0xf6 ::  0.40% (2158)
0xf9 ::  0.28% (1509)
0xfd ::  0.26% (1393)
0xf4 ::  0.21% (1138)
0xcd ::  0.21% (1129)
0xc2 ::  0.21% (1112)
0xc0 ::  0.20% (1072)
0xcf ::  0.19% (1034)
0xca ::  0.18% (952)
0xce ::  0.16% (849)
0xc1 ::  0.15% (821)
0xcc ::  0.11% (603)
0xc4 ::  0.10% (554)
0xd1 ::  0.09% (477)
0xd0 ::  0.09% (461)
0xd2 ::  0.08% (453)
0xc8 ::  0.08% (436)
0xb8 ::  0.08% (431)
0xdf ::  0.06% (303)
0xfa ::  0.05% (283)
0xc3 ::  0.05% (263)
0xdd ::  0.04% (235)
0xd7 ::  0.04% (215)
0xc5 ::  0.03% (184)
0xcb ::  0.03% (144)
0xc7 ::  0.02% (111)
0xd3 ::  0.02% (109)
0xc6 ::  0.02% (81)
0xd8 ::  0.01% (69)
0xd4 ::  0.01% (68)
0xd5 ::  0.01% (61)
0xd6 ::  0.00% (21)
0xde ::  0.00% (8)
0xdc ::  0.00% (4)
0xc9 ::  0.00% (2)
0xd9 ::  0.00% (2)
ALL  :: 100.0% (538641)
"""
        self.__test_subprocess('test_voyna_i_mir_cp1251.txt', expected_output)

if __name__ == '__main__':
    unittest.main()
